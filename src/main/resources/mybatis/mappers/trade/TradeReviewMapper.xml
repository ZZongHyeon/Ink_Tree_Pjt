<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.trade.dao.TradeReviewDAO">

	<select id="getChatUser" parameterType="int" resultType="com.boot.chat.dto.ChatRoomRequest">
	    SELECT 
	        cr.ROOMID,
	        cr.POSTID,
	        cr.SELLERNUMBER,
	        cr.BUYERNUMBER AS buyerNumber,
	        u.USERNAME AS buyerName
	    FROM TRADE_CHATROOM cr
	    JOIN USERINFO u ON u.USERNUMBER = cr.BUYERNUMBER
	    WHERE cr.POSTID = #{postId}
	</select>



    <!-- ✅ 2. 거래 완료 후 보여줄 태그 마스터 조회 -->
    <select id="getTags" resultType="com.boot.trade.dto.TradeTagsDTO">
        SELECT 
            TAG_CODE,
            TAG_TYPE,
            TAG_LABEL,
            TAG_EXPLAN
        FROM TRADE_TAG_MASTER
        ORDER BY TAG_CODE ASC
    </select>


    <!-- ✅ 3. 태그 평가 저장 -->
    <insert id="insertTag">
        INSERT INTO TRADE_TAG_LOG(
            TRADE_RECORD_ID,
            TAG_CODE,
            REVIEWER_ID,
            REVIEWEE_ID,
            CREATED_AT
        ) VALUES (
            #{tradeRecordId},
            #{tagCode},
            #{reviewerId},
            #{revieweeId},
            SYSDATE
        )
    </insert>


    <!-- ✅ 4. 마이페이지 – 내가 받은 전체 태그 통계 -->
    <select id="getUserTagStatistics" resultType="com.boot.trade.dto.TradeReviewDTO">
        SELECT 
            tm.TAG_CODE,
            tm.TAG_LABEL,
            COUNT(*) AS count
        FROM TRADE_TAG_LOG tl
        JOIN TRADE_TAG_MASTER tm ON tm.TAG_CODE = tl.TAG_CODE
        WHERE tl.REVIEWEE_ID = #{userId}
        GROUP BY tm.TAG_CODE, tm.TAG_LABEL
        ORDER BY COUNT(*) DESC
    </select>


    <!-- ✅ 5. 디테일뷰 – 태그 상위 N개 -->
    <select id="getTopTags" resultType="com.boot.trade.dto.TradeReviewDTO">
        SELECT
            tm.TAG_CODE,
            tm.TAG_LABEL,
            COUNT(*) AS count
        FROM TRADE_TAG_LOG tl
        JOIN TRADE_TAG_MASTER tm ON tm.TAG_CODE = tl.TAG_CODE
        WHERE tl.REVIEWEE_ID = #{userId}
        GROUP BY tm.TAG_CODE, tm.TAG_LABEL
        ORDER BY COUNT(*) DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>


    <!-- ✅ 6. 동일 거래에 같은 리뷰어가 이미 평가했는지 -->
    <select id="alreadyReviewed" resultType="int">
        SELECT COUNT(*)
        FROM TRADE_TAG_LOG
        WHERE TRADE_RECORD_ID = #{tradeRecordId}
        AND REVIEWER_ID = #{reviewerId}
    </select>


    <!-- ✅ 7. 거래 완료 여부 확인 -->
    <select id="isTradeCompleted" resultType="int">
        SELECT COUNT(*)
        FROM TRADE_RECORD
        WHERE TRADE_RECORD_ID = #{tradeRecordId}
        AND STATUS = 'COMPLETED'
    </select>

</mapper>
